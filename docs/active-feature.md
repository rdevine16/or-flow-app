# Current Work: Audit Remediation

## Goal
Execute the 15-phase remediation plan from `docs/implementation-plan.md`, fixing 137+ issues found during the codebase audit. All findings are in `docs/audit-findings/`.

## Status
- **Branch:** `fix/audit-remediation` (not yet created)
- **Current Phase:** Not started — review in progress
- **Implementation Plan:** `docs/implementation-plan.md`
- **Findings:** `docs/audit-findings/` (all 10 files complete)

## Strategy
- All 15 phases, executed in order
- Single branch: `fix/audit-remediation`
- One phase per session (per CLAUDE.md rules)
- Include `supabase/migrations/20260224211526_remote_commit.sql` in first commit (remote schema sync)

---

## Review Q&A

> Generated by /review on 2026-02-24

### Review Progress
- [x] General scope & strategy (Qs 1-4)
- [x] Phase 1: Security Emergency (Qs 5-11)
- [x] Phase 2: Auth & Session Fixes (Qs 12-16)
- [x] Phase 3: DB Constraints & Integrity (Qs 17-24)
- [x] Phase 4: Flag & Data Quality Activation (Qs 25-32)
- [ ] Phase 5: Cron Jobs & MV Management
- [ ] Phase 6: Permission System Integration
- [ ] Phase 7: Hard Delete to Soft Delete Conversion
- [ ] Phase 8: Dropdown & Lookup Fixes
- [ ] Phase 9: Validation Layer
- [ ] Phase 10: Audit Logging Gap Fill
- [ ] Phase 11: Template Builder Safety
- [ ] Phase 12: Analytics Consistency
- [ ] Phase 13: Dead Code Cleanup
- [ ] Phase 14: Code Quality & Decomposition
- [ ] Phase 15: Future Improvements

---

### General Scope & Strategy

**Q1:** The implementation plan has 15 phases (23 critical, 31 high, 48 medium, 35+ low issues). Do you want to execute all 15 phases sequentially, or cherry-pick?
**A1:** All 15 phases, in order.

**Q2:** What branching strategy for the remediation work?
**A2:** One branch for all (`fix/audit-remediation`). Single big PR at the end.

**Q3:** The untracked `supabase/migrations/20260224211526_remote_commit.sql` contains RLS policy renames, ~80 new indexes, and pg_cron/pg_net extensions. Include it?
**A3:** Yes, include it as-is on the remediation branch (first commit to sync local with remote).

**Q4:** Review depth — cover all 15 phases in one session or split?
**A4:** Split into groups of 2 phases per session. Save progress to active-feature.md so new sessions know where review left off.

---

### Phase 1: Security Emergency

**Q5:** Phase 1 lists `settings/subscription` as needing mutation guards, but it's read-only. And `api/create-device-rep/route.ts` already has Zod `.email()` validation. Drop these?
**A5:** Keep subscription — add preemptive guard anyway. Drop create-device-rep (already validated).

**Q6:** For the 4 settings pages needing permission guards (notifications, closures, device-reps, analytics), which permission key?
**A6:** Use `settings.manage` for all 4. Consistent with existing pages like procedures.

**Q7:** Should the audit_log immutability migration also add SELECT/INSERT policies?
**A7:** Just deny UPDATE/DELETE. Assume SELECT/INSERT already handled.

**Q8:** What RLS policies for `login_attempts`?
**A8:** Skip this for now. Not urgent since it's not user-facing.

**Q9:** Should the `or_hourly_rate >= 0` constraint also bundle other financial constraints?
**A9:** Just `or_hourly_rate` in Phase 1. Keep financial constraints separated per the plan (Phase 3).

**Q10:** For email validation on invite forms, simple regex or shared Zod schema?
**A10:** Simple inline regex for now. Phase 9 will replace with Zod later.

**Q11:** Global security page access guard — redirect to /dashboard or show AccessDenied?
**A11:** Redirect to /dashboard (standard pattern). Matches all other admin pages.

#### Phase 1 Adjusted Scope
- Add `isGlobalAdmin` redirect guard to `app/admin/global-security/page.tsx`
- Add `audit_log` UPDATE/DELETE deny policies (migration)
- Add `can('settings.manage')` guards to 4 pages: notifications, closures, device-reps, analytics
- Add preemptive `can('settings.manage')` guard to subscription page (read-only but future-proof)
- Add `or_hourly_rate >= 0` CHECK constraint (migration)
- Add inline email regex to 2 invite forms: settings/users, admin/facilities/[id]
- Drop: create-device-rep email validation (already done), login_attempts RLS (deferred)

---

### Phase 2: Auth & Session Fixes

**Q12:** Rate limiter fix scope — Supabase Auth has built-in rate limiting. How much effort on custom rate limiter?
**A12:** Full fix (server-side login + DB-backed rate limiter). Defense in depth for healthcare app.

**Q13:** User deactivation needs `auth.admin.signOut()` which requires service_role key (can't be in browser). Create API route?
**A13:** Yes, create `/api/admin/deactivate-user` API route that handles both DB update and session termination server-side.

**Q14:** Impersonation write protection — how deep?
**A14:** Full server-side verification. Create impersonation sessions in DB, pass session ID in API headers, verify in every write route.

**Q15:** Invite API fix — just rename table or also verify columns?
**A15:** Fix table name (`invites` → `user_invites`) AND verify every column matches actual schema.

#### Phase 2 Adjusted Scope
- Fix invite API table references: `invites` → `user_invites` in 2 routes + verify column names
- Fix `create-device-rep` non-existent `implant_company_id` column on `facility_device_reps`
- Full rate limiter rewrite: create `/api/auth/login` route, DB-backed storage, real client IP
- Create `/api/admin/deactivate-user` route for server-side session termination
- Full impersonation server-side verification: DB sessions, header-based verification in write routes
- Migration: `force_expire_user_sessions(user_id)` function

---

### Phase 3: DB Constraints & Integrity

**Q17:** Phase 3 scope reduction: 3 items already have constraints — `financial_targets.month` CHECK, `facility_holidays` month/day CHECKs, and `facility_closures` UNIQUE on `(facility_id, closure_date)`. Drop from scope?
**A17:** Drop all 3. Already constrained — no work needed.

**Q18:** Delay dual-write orphan: `handleRemoveDelay` only deletes from `case_flags`, orphaning `case_delays`. App-level dual delete or DB CASCADE?
**A18:** DB CASCADE. Add `ON DELETE CASCADE` FK from `case_delays` to `case_flags`. One migration, zero app code, all deletion paths covered.

**Q19:** NOT NULL backfill strategy for `case_implants.case_id` and `case_milestones.facility_milestone_id`?
**A19:** Pre-check approach. Migration checks for NULLs first — abort if found, otherwise add NOT NULL constraint.

**Q20:** Duplicate `case_flags` prevention — delete existing dupes before adding UNIQUE index?
**A20:** Add index, delete dupes first. Migration: DELETE older duplicate rows (keep newest per case_id+flag_rule_id), then CREATE UNIQUE INDEX.

**Q21:** `seed_facility_flag_rules()` missing columns — also expand to copy ALL global templates (including custom)?
**A21:** Fix 3 columns (`threshold_value_max`, `cost_category_id`, `is_active`), keep built-in only. Custom templates are optional per-facility.

**Q22:** `milestone_template_items(template_id, display_order)` UNIQUE constraint — how to handle @dnd-kit drag reorder collisions?
**A22:** UNIQUE with batch reorder. Change the reorder save to DELETE all items then re-INSERT in new order (within a transaction).

**Q23:** CHECK constraints + indexes — one migration or split?
**A23:** Single migration for all CHECK constraints + indexes. They're all additive, non-destructive, logically grouped as "schema tightening".

**Q24:** `display_order >= 0` CHECK — which tables?
**A24:** All 10 tables with `display_order`: `flag_rules`, `facility_milestones`, `milestone_types`, `milestone_template_items`, `facility_phases`, `phase_templates`, `procedure_types`, `preop_checklist_fields`, `preop_checklist_field_templates`, `or_rooms`.

**Q24b:** Should Phase 1's `or_hourly_rate` constraint be bundled into Phase 3 migration?
**A24b:** Keep separate. Phase 1 has its own migration. Matches phase boundaries.

#### Phase 3 Adjusted Scope
- Migration: `ON DELETE CASCADE` FK from `case_delays` to `case_flags` (delay orphan fix)
- Migration: NOT NULL on `case_implants.case_id` and `case_milestones.facility_milestone_id` (with pre-check for existing NULLs)
- Migration: DELETE duplicate `case_flags`, then CREATE UNIQUE INDEX on `(case_id, flag_rule_id) WHERE flag_rule_id IS NOT NULL`
- Migration: Update `seed_facility_flag_rules()` to copy `threshold_value_max`, `cost_category_id`, `is_active`
- Migration: UNIQUE on `milestone_template_items(template_id, display_order)` + update `useTemplateBuilder` to use DELETE+re-INSERT pattern
- Migration (single file): all remaining CHECK constraints:
  - `flag_rules.threshold_value_max >= threshold_value` (when both not null)
  - `flag_rules` percentile range 0-100 when threshold_type = 'percentile'
  - `closing_handoff_minutes BETWEEN 0 AND 120` on users
  - `display_order >= 0` on all 10 tables
  - Non-negative on `procedure_reimbursements.reimbursement`, `procedure_cost_items.amount`, `surgeon_cost_items.amount`
  - Partial index on `metric_issues(facility_id) WHERE resolved_at IS NULL`
- Drop from scope: `financial_targets.month` CHECK (exists), `facility_holidays` CHECKs (exist), `facility_closures` UNIQUE (exists)

---

### Phase 4: Flag & Data Quality Activation

**Q25:** Flag detection integration — how to trigger flag evaluation on production cases?
**A25:** Client-side on validation. Add `evaluateCasesBatch()` call in the case detail page when user clicks "Validate". Immediate, no new infra.

**Q26:** Hardcoded `'patient_in'` milestone name in stale detection — how to fix?
**A26:** Use `source_milestone_type_id` lookup. Find the global 'patient_in' milestone_type, then find the facility_milestone with that source. Consistent with v2.0 pattern.

**Q27:** Per-case error handling in edge function — just try/catch or also add error counter?
**A27:** Try/catch + error counter. Include in response JSON: `{ processed: N, failed: N, errors: [...] }`.

**Q28:** Missing `is_active` filter in data quality queries — which filters to add?
**A28:** Both filters. Add `is_excluded_from_metrics = false` AND `is_draft = false`. Drafts aren't real cases, excluded cases shouldn't be re-flagged.

**Q29:** Nightly cron job — also add auth to the edge function now or defer to Phase 6?
**A29:** Add auth now. Add bearer token validation to edge function in Phase 4. Cron job passes service_role key as auth header.

**Q30:** Delete unused `lib/stale-case-detection.ts` — also extract shared stale detection module?
**A30:** Delete + extract shared module. Canonical source in `lib/`, copied to edge function dir at build time (same pattern as `orbitScoreEngine.ts`).

**Q31:** Flag summary bug fix — also add exclusion filter to `flagsByCase`?
**A31:** Fix severity only. The cases table already filters excluded cases at the query level before calling `flagsByCase`.

**Q32:** Issue type severity mapping for the 3 new rows?
**A32:** As planned: `stale_in_progress=warning`, `abandoned_scheduled=warning`, `no_activity=info`.

#### Phase 4 Adjusted Scope
- Migration: INSERT 3 missing `issue_types` rows (`stale_in_progress`/warning, `abandoned_scheduled`/warning, `no_activity`/info)
- Fix flag summary bug: `lib/dal/cases.ts:530` — change `flag.flag_type` to `flag.severity`
- Fix hardcoded milestone: `lib/dataQuality.ts:625` — use `source_milestone_type_id` lookup instead of `.eq('name', 'patient_in')`
- Add per-case try/catch + error counter to `supabase/functions/run-data-quality-detection/index.ts`
- Add `is_excluded_from_metrics = false` and `is_draft = false` filters to data quality queries (both `dataQuality.ts` and edge function)
- Delete `lib/stale-case-detection.ts`, extract shared stale detection to `lib/stale-detection-shared.ts`, copy to edge function dir
- Add bearer token auth to `run-data-quality-detection` edge function
- Migration: Schedule nightly data quality cron job via pg_cron (`0 2 * * *`)
- Integrate `evaluateCasesBatch()` into case detail page validation handler (client-side, immediate)
- Drop from scope: create-device-rep email validation (already done in Phase 1 review)

---

## Audit Context (preserved for reference)

### Completed Audit Deliverables
- `docs/audit-findings/domain-1-cases.md`
- `docs/audit-findings/domain-2-milestones.md`
- `docs/audit-findings/domain-3-financials.md`
- `docs/audit-findings/domain-4-flags-quality.md`
- `docs/audit-findings/domain-5-users-auth.md`
- `docs/audit-findings/domain-6-settings.md`
- `docs/audit-findings/cross-cutting-data-entry.md`
- `docs/audit-findings/cross-cutting-db-schema.md`
- `docs/audit-findings/data-flow-test-results.md`
- `docs/audit-findings/FINAL-AUDIT-REPORT.md`
- `docs/implementation-plan.md` (15-phase remediation plan)
- `docs/code-audit-playbook.md` (audit methodology)
- `scripts/audit-data-flow-test.ts` (data flow verification script)
