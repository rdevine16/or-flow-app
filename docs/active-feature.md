# Feature: Demo Data Generator Redesign

## Goal
Rebuild the demo data generator into a professional-grade tool for creating client demo environments. The current generator produces statistically flat data that fails to showcase the application's anomaly detection, flag system, financial analytics, and data quality features. The redesign adds realistic outlier generation, per-surgeon problem profiles, per-day room assignments, surgeon-specific procedure durations, proper flip room callback timing, and a polished wizard UI integrated into the global admin pages.

## Requirements

### Wizard UI
- 6-step sidebar wizard modeled after `docs/FacilityWizard.jsx` layout
- Steps: Facility → Surgeon Profiles → Room Schedule → Outlier Config → Review → Running
- Integrated into admin sidebar navigation (Management group)
- Visual day/room grid for per-day room assignments (Mon: OR-1 + OR-2, Tue: OR-1 + OR-3)
- Block schedule integration: auto-fill operating days from `block_schedules` table
- Per-surgeon independent outlier checkboxes (Late Starts, Long Turnovers, Extended Phases, Callback Delays)

### Generator Engine
- Surgeon-specific procedure durations: query `surgeon_procedure_duration` first, fall back to `procedure_types.expected_duration_minutes`
- Callback timing happens PARTWAY THROUGH INCISION (not at prep_drape_complete)
- Transit + scrub gap (3-8 min) between rooms for flip room surgeons
- Per-day room assignments (different rooms on different days of the week)
- All outliers CASCADE through subsequent milestones

### Outlier Engine
- Late starts / FCOTS violations: 15-45 min late, cascading through day
- Long turnovers: 30-60 min vs normal 15-20 min
- Extended surgical phases: 40-80% over median, trigger critical flags
- Callback delays: surgeon called back 10-25 min late, flip room idles
- "Bad day" scenarios: 1-2 days per month where everything compounds
- Fast outliers: suspiciously quick cases

### Missing Data Generation
- Run BOTH flag engines post-generation (flag-detection.ts + flagEngine.ts)
- Generate cancelled cases (~5-8% with cancellation_reasons)
- Generate case delays (~10-15% with delay_types)
- Leave ~10% of cases unvalidated for Data Quality page
- Assign case complexities to joint/spine cases

### Purge Fixes
- Add missing tables: case_flags, case_complexities, case_device_companies, case_device_activity, metric_issues

## Database Context
- Table: `surgeon_procedure_duration` — surgeon-specific expected_duration_minutes overrides
- Table: `block_schedules` — recurring surgeon availability by day of week
- RPC: `get_blocks_for_date_range` — expands recurring blocks into daily instances
- Table: `case_flags` — auto-detected and rule-based flags
- Table: `case_delays` — user-reported delays with delay_type_id
- Table: `case_complexities` — junction table linking cases to complexity factors
- Table: `cancellation_reasons` — facility-specific cancellation reason codes

## UI/UX
- Route: `/admin/demo`
- Sidebar wizard layout (FacilityWizard.jsx pattern)
- Visual day/room grid for room assignments
- Per-surgeon outlier checkboxes
- Real-time progress during generation

## Files Likely Involved
- `app/admin/demo/page.tsx` — rebuild with wizard shell
- `lib/demo-data-generator.ts` — engine overhaul
- `app/api/demo-data/route.ts` — API updates
- `components/layouts/navigation-config.tsx` — admin nav link
- `docs/FacilityWizard.jsx` — layout reference

## iOS Parity
- [x] iOS can wait

## Known Issues / Constraints
- `scheduled_duration_minutes` column was dropped — do not reference
- Block schedules don't include room assignments — rooms are case-level
- Do NOT create block schedules, pricing, or financial targets (already established)

## Out of Scope
- Block schedule creation
- Pricing/reimbursement data creation
- Financial targets creation
- Patient demographic data

## Acceptance Criteria
- [ ] Demo wizard accessible from admin sidebar → Management group
- [ ] 6-step wizard with sidebar layout matches FacilityWizard.jsx design
- [ ] Block schedules auto-fill surgeon operating days
- [ ] Visual day/room grid allows per-day room assignments
- [ ] Per-surgeon outlier checkboxes produce visibly different metrics
- [ ] Callback timing during incision (not prep_drape_complete)
- [ ] Transit gap (3-8 min) between flip rooms
- [ ] Case flags populated post-generation (both engines)
- [ ] ~3% cancelled cases, ~5-8% delays, ~2% unvalidated
- [ ] Purge cleans all related tables
- [ ] All tests pass (`npm run typecheck && npm run test`)
- [ ] No TypeScript `any` types introduced

---

## Review Q&A

> Generated by /review on 2026-02-21

**Q1: Wizard architecture — mirror facility wizard pattern (page.tsx orchestrator + 6 step files + types.ts) or keep monolithic?**
**A1:** Mirror facility wizard pattern. page.tsx as orchestrator + 6 separate step component files under app/admin/demo/steps/ + types.ts.

**Q2: Real-time progress — SSE stream, polling, or chunked response?**
**A2:** Server-Sent Events (SSE) stream. Convert generation to a streaming endpoint that sends granular progress events (phase transitions + batch counts).

**Q3: Milestone concerns — visibility, correctness, or both?**
**A3:** Both. Show milestone insert counts during SSE stream AND run a post-generation validation pass. If any cases are missing milestones, flag them in the result summary.

**Q4: Staff assignment concerns?**
**A4:** Anesthesia unification concern. Generator must use the new case_staff pattern (not the dropped cases.anesthesiologist_id). Also: CRNAs are added as anesthesia providers too.

**Q5: CRNA role handling?**
**A5:** CRNAs have their own user_role in the database. Generator should look for both 'anesthesiologist' and 'crna' roles.

**Q6: Anesthesia provider distribution across cases?**
**A6:** Pool all anesthesia providers (anesthesiologists + CRNAs) and assign round-robin to room-days. Some rooms get an MD, some get a CRNA.

**Q7: Wizard step count — keep 6 steps or merge some?**
**A7:** Keep 6 steps as planned. Room Schedule and Outlier Config each warrant their own step.

**Q8: Milestone timing — scale by surgeon speed profile?**
**A8:** Yes. Fast surgeons get ~70% of template offsets, average ~100%, slow ~130%. Makes generated data more realistic.

**Q9: SSE event granularity?**
**A9:** Phase-level + per-batch counts. One event per major phase transition plus per-batch insert counts (~20-50 events total). Good balance of visibility without noise.

**Q10: Flag engines — run both or just flagEngine.ts?**
**A10:** Both engines, different purposes. flagEngine.ts for persistent threshold-based case_flags. flag-detection.ts for additional flag types it uniquely detects.

**Q11: Persisting flag-detection.ts results?**
**A11:** Seed flag_rules so flagEngine catches everything (late starts, long turnovers, extended phases, fast cases). If rules are missing, flagEngine covers it via seeded rules. No need to map flag-detection.ts output to case_flags separately.

**Q12: Cancelled cases — should they have milestones?**
**A12:** Pre-day cancellations only (no milestones). Cancelled cases have NO milestones, no staff, no implants — just the case shell with cancelled_at and a reason.

**Q13: Surgeon-specific procedure durations — create entries or use existing?**
**A13:** Use existing data. Each procedure_type has expected_duration_minutes, some surgeons have surgeon_procedure_duration overrides. Use those. Don't create synthetic entries.

**Q14: Purge scope — include surgeon_procedure_duration?**
**A14:** Leave surgeon_procedure_duration alone. These are configuration/override entries, not computed data. Persist across purge+regenerate cycles.

**Q15: API route — separate streaming endpoint or add to existing?**
**A15:** Separate streaming endpoint. Keep /api/demo-data/route.ts for list/status/clear actions. Add new /api/demo-data/generate/route.ts for SSE stream.

**Q16: Outlier engine — inline during generation or post-processing?**
**A16:** Inline during generation. Hook into generateSurgeonCases() and modify milestone offsets as each case is built. Cascading happens naturally.

**Q17: Block schedule integration — show recurring days, allow override?**
**A17:** Show recurring days from block_schedules, allow override. Extract unique day-of-week, pre-check those days. User can uncheck or add extra days. Block schedule is a starting point, not a constraint.

**Q18: Progress bar UI design?**
**A18:** Linear progress bar with phase labels. Horizontal 0-100% bar at top, current phase name below, running counts underneath. Plus a vertical phase checklist with checkmarks for completed phases.

**Q19: Room grid — per-surgeon grids or global weekly schedule view?**
**A19:** Per-surgeon day/room grids. Each surgeon gets their own card with a grid: rows = operating days, columns = facility rooms. Click to toggle. Max 2 rooms per day.

**Q20: Fast outliers — global or per-surgeon?**
**A20:** Per-surgeon toggle. Each outlier type (including Fast Cases) has: (1) enabled/disabled toggle, (2) frequency slider (% of cases affected), (3) magnitude slider (how far off ± from normal).

**Q21: Outlier config UI — toggles + dual sliders per type?**
**A21:** Yes. Toggle + dual sliders (frequency + magnitude) per outlier type per surgeon. 5 rows per surgeon: Late Starts, Long Turnovers, Extended Phases, Callback Delays, Fast Cases. Plus Bad Day frequency slider.

**Q22: No new database tables?**
**A22:** Correct. No new tables. Only populate existing tables. All new files are TypeScript source only.

**Q23: Outlier engine — separate file?**
**A23:** Yes. lib/demo-outlier-engine.ts as a standalone module with pure functions. Types co-located is fine. Keeps the main generator from growing to 1,500+ lines.

**Q24: Data validation split — what percentage unvalidated?**
**A24:** 2% unvalidated (not 10%). Validate 98% of completed cases, leave 2% with data_validated=false.

**Q25: Cancellation and delay rates?**
**A25:** Lower everything proportionally: ~3% cancelled, ~5-8% delays, ~2% unvalidated. Demo should look well-run, showing "here's what we detect" not "this place is a disaster."

**Q26: Flag rules missing — check and warn or auto-seed?**
**A26:** Check and warn if missing. Show warning in progress stream if no flag_rules configured. Don't auto-create.

**Q27: Config status panel — expand with all relevant counts?**
**A27:** Yes. Show: Surgeons, Rooms, Procedures, Payers, Milestones, Flag Rules, Cancellation Reasons, Delay Types, Existing Cases. Highlight zeros in amber as warnings.

**Q28: Specialties — keep 3 or add more?**
**A28:** Keep the 3 specialties as-is: Joint, Hand/Wrist, Spine.

**Q29: Phase 6 split?**
**A29:** Split Phase 6 into two: Phase 6a (outlier engine + cascading delays) and Phase 6b (missing data: cancelled cases, delays, complexities, flag detection, purge fixes). Total becomes 8 phases.

**Q30: Review step detail level?**
**A30:** Compact summary cards per surgeon: name, specialty, speed, operating days, rooms per day, procedure count, outlier badges. Total estimated cases at bottom. Edit buttons per section.

**Q31: SSE wiring — generator with progress callback?**
**A31:** Yes. Keep generation logic in lib/demo-data-generator.ts. Add onProgress callback parameter. API route creates ReadableStream and passes callback that writes SSE events.

**Q32: Success screen content?**
**A32:** Rich summary showing per-case averages: milestones/case, staff/case, flags/case, total cases, cancelled count, delayed count. Not raw totals — per-case metrics.

**Q33: Back button state preservation?**
**A33:** All wizard state must persist when navigating between steps. In-memory state (React useState in parent page.tsx). No localStorage persistence needed — matches facility wizard pattern.

**Q34: Date range and holidays?**
**A34:** Keep months-of-history in Facility step. Compute US federal holidays dynamically (algorithmically, not hardcoded). Future-proof.

**Q35: Phase execution order?**
**A35:** Sequential: 1 → 2 → 3 → 4 → 5 → 6a → 6b → 7 → 8. One phase per session.

**Q36: Nav item naming and access?**
**A36:** "Demo Generator" — global_admin only. In the Management group of admin sidebar.

**Q37: Error handling during SSE generation?**
**A37:** SSE error event + automatic rollback. If any phase fails, attempt to purge all generated data, send error event. User gets clean slate to retry.

**Q38: Weekly OR schedule preview — which steps?**
**A38:** Both. Live-updating combined schedule in Room Schedule step (spot conflicts) AND read-only version in Review step.

**Q39: Device data — purge only or generate too?**
**A39:** Generate basic device data. For cases with implants (joint specialty), create case_device_companies and case_device_activity records linking to the vendor.
