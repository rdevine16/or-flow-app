# Implementation Plan: Epic FHIR Integration + Patient Fields

> Generated by /web-audit on 2026-02-28

## Summary

Two features delivered together across 6 phases:

1. **Patient Fields on Cases** — Add patient info (name, MRN, DOB) to case creation, case list, case detail, search, and CSV export. Uses existing `patients` table and `cases.patient_id` FK.
2. **Epic FHIR Integration** — SMART on FHIR OAuth connection to Epic, entity mapping (surgeons/rooms/procedures), global field mapping admin UI, and on-demand surgical case import with full audit trail.

## Interview Notes (Key Decisions)

| # | Decision | Choice |
|---|----------|--------|
| 1 | Scope | Full spec, 6 phases |
| 2 | Epic audit logging | Dedicated `epicAudit` domain in `audit-logger.ts` — actions: `epic.connected`, `epic.disconnected`, `epic.token_expired`, `epic.cases_imported`, `epic.case_import_failed`, `epic.mapping_created`, `epic.mapping_updated`, `epic.mapping_deleted`, `epic.auto_match_run`, `epic.field_mapping_updated`, `epic.field_mapping_reset` |
| 3 | Epic case numbers | Use FHIR appointment ID (e.g., `EPIC-{fhir_appointment_id}`) |
| 4 | Token storage | Supabase Vault (pgsodium) from day one — enable extension in migration |
| 5 | Case mapper | Smart coercion (date parsing, FHIR reference → UUID via entity mapping, type conversion) |
| 6 | Epic settings pages | Separate routes (`/epic`, `/epic/mappings`, `/epic/import`) — not tabs |
| 7 | MRN conflict | Modal dialog: "MRN exists for X. Link existing or create new?" |
| 8 | Redirect URI | `EPIC_REDIRECT_URI` env var (configurable per environment) |
| 9 | Audit requirement | All Epic case imports must appear in audit log with `imported_by` attribution and source tracking |
| 10 | Patient fields | Always visible — no toggle or feature flag |
| 11 | Analytics | NEVER include patient-identifiable data (hard rule) |
| 12 | Duration mapping | Skip in v1 (Q6) — facility admins set surgeon durations manually |
| 13 | Field mapping UNIQUE | Widen to `(fhir_resource_type, fhir_field_path, orbit_table, orbit_column)` (Q24) |
| 14 | Import date range | Forward only, default next 7 days, max 30 days (Q28) |
| 15 | Imported case status | "Scheduled" (Q29) |
| 16 | Cases with missing mappings | Block import — checkbox disabled until resolved (Q15) |
| 17 | Case edit mode | Patient fields populated + editable; clearing all fields unlinks patient (Q5) |
| 18 | Patient search | Extend case list search to match patient name/MRN (Q7) |
| 19 | CSV export | Include patient name and MRN (Q8) |

---

## Phase 1: Patient Fields on Cases

**Complexity:** Large

### What it does
- Adds `source` column to `cases` table (`'manual'`, `'epic'`, `'cerner'`)
- Alters `create_case_with_milestones` RPC: adds `p_patient_id UUID DEFAULT NULL` and `p_source TEXT DEFAULT 'manual'`
- Adds optional "Patient Information" section to CaseForm (first name, last name, MRN, DOB)
- Conditional validation: if any patient field entered → first name + last name required
- MRN lookup within facility to avoid duplicates; MRN conflict → modal dialog
- Patient fields editable on existing cases; clearing all fields unlinks patient
- Adds "Patient" column to case list after Surgeon
- Adds patient name inline to case detail header metadata row (MRN/DOB on hover tooltip)
- Extends case list search to match patient first_name, last_name, MRN
- Adds patient name + MRN to CSV export
- Removes legacy `patient_dob`/`patient_phone` ghost fields from CaseDetail type
- Adds Epic badge pill support (shown when `source = 'epic'`) in Procedure cell

### Files touched
| File | Change |
|------|--------|
| `supabase/migrations/YYYYMMDD_patient_fields_and_source.sql` | New migration: add `source` column to cases + alter RPC with `p_patient_id` and `p_source` |
| `lib/dal/cases.ts` | Update `CASE_LIST_SELECT` (add patient join + source), `CASE_DETAIL_SELECT` (add patient join); update types: remove `patient_dob`/`patient_phone` from CaseDetail, add `patient?: { first_name, last_name, mrn, date_of_birth } | null` + `source` field to both CaseListItem and CaseDetail; update search query for patient name/MRN; update `listForExport` |
| `lib/validation/schemas.ts` | Add patient field schemas with conditional validation |
| `components/cases/CaseForm.tsx` | Add "Patient Information" section after surgeon/procedure/room; MRN lookup on blur; MRN conflict modal dialog; pass `p_patient_id` and `p_source` to RPC; handle edit mode (populate from linked patient, clear = unlink) |
| `components/cases/CasesTable.tsx` | Add "Patient" column after Surgeon showing `Last, First`; add Epic badge pill in Procedure cell when `source = 'epic'` |
| `app/cases/[id]/PageClient.tsx` | Add patient name inline to header metadata row; MRN/DOB on hover tooltip |
| `components/cases/CasesFilterBar.tsx` | Extend search to match patient first_name, last_name, MRN |
| `lib/hooks/useCasesPage.ts` | Update CSV export headers to include Patient Name and MRN columns; update search logic |

### Commit message
`feat(cases): phase 1 - add patient fields to case creation, list, detail, search, and export`

### 3-stage test gate
1. **Unit:** Patient field validation (conditional required logic), MRN lookup function, MRN conflict modal rendering, source column default
2. **Integration:** Create case with patient data → verify patient record in `patients` table → verify `cases.patient_id` linked → verify case list shows Patient column → verify case detail shows patient in metadata row → search by patient name → search by MRN → export CSV with patient data; create case with MRN matching existing patient → verify reuse (no duplicate); create case without patient data → verify `patient_id` is null
3. **Workflow:** Create case with patient info → view in list (Patient column visible) → open detail (patient in header) → search by MRN (found) → export CSV (patient columns present) → edit case (patient fields populated) → clear patient fields → save → verify patient unlinked

---

## Phase 2a: Epic Schema + OAuth Auth Flow

**Complexity:** Large

### What it does
- Enables `pgsodium` extension for Supabase Vault
- Creates `epic_connections` table with Vault-encrypted token storage
- Creates `epic_entity_mappings` table
- Creates `epic_field_mappings` table with widened UNIQUE constraint `(fhir_resource_type, fhir_field_path, orbit_table, orbit_column)` and default seed data (skip duration mapping per Q6)
- Creates `epic_import_log` table
- RLS policies for all 4 tables per spec
- Indexes per spec
- `updated_at` triggers on connections, entity_mappings, field_mappings
- Implements OAuth connect/callback/disconnect API routes (state in HTTP-only cookie, 5min TTL)
- Creates token manager with Vault encrypt/decrypt
- Creates FHIR type definitions (only fields ORbit consumes)
- Creates Epic DAL module following existing patterns
- Adds `epicAudit` domain to `audit-logger.ts` with full action set
- Documents environment variables

### Files touched
| File | Change |
|------|--------|
| `supabase/migrations/YYYYMMDD_epic_schema.sql` | New: all 4 tables + Vault setup + RLS + indexes + triggers + seed data |
| `lib/epic/types.ts` | New: TypeScript interfaces for FHIR Appointment, Patient, Practitioner, Location, ServiceRequest, Bundle |
| `lib/epic/token-manager.ts` | New: `getEpicAccessToken(facilityId)`, `storeEpicToken(facilityId, token)`, `epicFhirRequest<T>(facilityId, resourcePath)` — Vault-based storage, expiry check |
| `lib/dal/epic.ts` | New: DAL functions for all Epic tables following `lib/dal/core.ts` patterns |
| `lib/dal/index.ts` | Export new `epicDAL` |
| `app/api/epic/auth/connect/route.ts` | New: GET — fetch SMART config, generate state → HTTP-only cookie, redirect to Epic |
| `app/api/epic/auth/callback/route.ts` | New: GET — validate state cookie, exchange code for token, store in Vault, upsert connection, redirect to settings |
| `app/api/epic/auth/disconnect/route.ts` | New: POST — clear Vault tokens, set status to disconnected, audit log |
| `lib/audit-logger.ts` | Add `epicAudit` domain with all action types + human-readable labels |
| `app/admin/audit-log/PageClient.tsx` | Add "Epic Integration" to ACTION_CATEGORIES filter |
| `app/settings/audit-log/PageClient.tsx` | Add "Epic Integration" to facility audit log categories |
| `.env.example` | Add `EPIC_CLIENT_ID`, `EPIC_CLIENT_SECRET`, `EPIC_FHIR_BASE_URL`, `EPIC_REDIRECT_URI` |

### Commit message
`feat(epic): phase 2a - epic schema, vault token storage, oauth auth flow, audit domain`

### 3-stage test gate
1. **Unit:** Token manager Vault encrypt/decrypt roundtrip, OAuth state generation/validation, FHIR type interfaces compile, epicAudit action labels defined
2. **Integration:** OAuth connect → callback → token stored in Vault → connection status = 'connected' → disconnect → Vault token cleared → status = 'disconnected'; verify RLS blocks cross-facility access to epic_connections; verify audit log entries for `epic.connected` and `epic.disconnected` with user attribution
3. **Workflow:** Full OAuth round-trip with Epic sandbox → connection row in DB → token encrypted in Vault → check audit log → disconnect → verify cleanup

---

## Phase 2b: Global Admin Field Mapping UI

**Complexity:** Small-Medium

### What it does
- Creates global admin page at `/admin/settings/epic-field-mapping`
- Full-page editable table: FHIR source (resource + field path) ↔ ORbit target (table + column) + label + description + active toggle
- Single "Save Changes" button (batch update)
- "Reset to Defaults" button with confirmation dialog (wipe + re-seed)
- Adds nav entry to admin settings under new "Integrations" group

### Files touched
| File | Change |
|------|--------|
| `app/admin/settings/epic-field-mapping/page.tsx` | New: server component with metadata |
| `app/admin/settings/epic-field-mapping/PageClient.tsx` | New: editable table, batch save, reset to defaults with confirmation |
| `components/settings/AdminSettingsLayout.tsx` | Add "Integrations" group with "Epic Field Mapping" item to `adminSettingsGroups` |
| `lib/dal/epic.ts` | Add field mapping functions: `listFieldMappings()`, `batchUpdateFieldMappings()`, `resetFieldMappingsToDefaults()` |

### Commit message
`feat(epic): phase 2b - global admin epic field mapping page`

### 3-stage test gate
1. **Unit:** Field mapping DAL functions (list, batch update, reset to defaults)
2. **Integration:** Load page → see pre-seeded defaults → edit mapping → save → reload → verify edit persisted → reset to defaults → verify originals restored; audit log shows `epic.field_mapping_updated` and `epic.field_mapping_reset`
3. **Workflow:** Global admin navigates to admin settings → finds "Epic Field Mapping" in Integrations group → views default mappings → edits one → saves → resets → confirms original state

---

## Phase 3: Facility Epic Settings + Entity Mapping

**Complexity:** Large

### What it does
- Updates integrations page: transforms Epic card from "Coming Soon" to active with connection status and Set Up/Manage buttons
- Creates Epic overview page (`/settings/integrations/epic`): connection status card, token expiry countdown, quick actions
- Creates entity mapping page (`/settings/integrations/epic/mappings`): Surgeons | Rooms | Procedures tabs, manual dropdown mapping, status indicators
- Creates API routes for connection status and entity mapping CRUD
- Removes `badge: 'soon'` from integrations nav item

### Files touched
| File | Change |
|------|--------|
| `app/settings/integrations/PageClient.tsx` | Transform Epic card: show connection status, "Set Up"/"Manage" buttons |
| `app/settings/integrations/epic/page.tsx` | New: server component |
| `app/settings/integrations/epic/PageClient.tsx` | New: connection status card (green/amber/red), connected_by, token expiry countdown, quick actions (Import, Mappings, Disconnect), reconnect prompt |
| `app/settings/integrations/epic/mappings/page.tsx` | New: server component |
| `app/settings/integrations/epic/mappings/PageClient.tsx` | New: Surgeons \| Rooms \| Procedures tabs, Epic ↔ ORbit dropdown mapping table, status indicators (Mapped/Suggested/Unmapped), filter tabs (All/Mapped/Unmapped) |
| `app/api/epic/status/route.ts` | New: GET — connection status + mapping stats |
| `app/api/epic/mappings/route.ts` | New: GET (list) + POST (upsert) entity mappings |
| `app/api/epic/mappings/[id]/route.ts` | New: DELETE entity mapping |
| `lib/dal/epic.ts` | Add: `listEntityMappings()`, `upsertEntityMapping()`, `deleteEntityMapping()`, `getConnectionStatus()`, `getMappingStats()` |
| `lib/settings-nav-config.ts` | Remove `badge: 'soon'` from integrations item |

### Commit message
`feat(epic): phase 3 - facility epic settings, entity mapping manager`

### 3-stage test gate
1. **Unit:** Entity mapping DAL functions, status calculation, mapping stats aggregation
2. **Integration:** Integrations page shows Epic card with correct status → navigate to overview → see connection info + token expiry → navigate to mappings → create/edit/delete mappings across all 3 tabs → verify RLS isolation between facilities; audit log shows `epic.mapping_created/updated/deleted`
3. **Workflow:** Facility admin sees Epic card → clicks Manage → views overview → navigates to mappings → maps surgeons/rooms/procedures → returns to overview → mapping summary updated

---

## Phase 4: FHIR Client + Case Import

**Complexity:** Large

### What it does
- Implements typed FHIR client (`lib/epic/fhir-client.ts`) for fetching appointments, patients, practitioners, locations
- Builds dynamic case mapper (`lib/epic/case-mapper.ts`) that reads field mappings from DB at import time with smart coercion (ISO dates → Postgres, references → UUIDs, string normalization)
- Creates case import page (`/settings/integrations/epic/import`) with date range picker, surgeon filter, preview table, sequential import with live progress
- Creates API routes for search and import
- Creates patient records from FHIR Patient resources during import
- Logs all import operations to `epic_import_log` with `imported_by` attribution
- Case numbers use FHIR appointment ID: `EPIC-{fhir_appointment_id}`
- Imported cases get `source = 'epic'` and status = "Scheduled"
- Duplicate detection via `fhir_appointment_id` in import log
- Cases with missing entity mappings have disabled checkboxes (blocked from import)

### Files touched
| File | Change |
|------|--------|
| `lib/epic/fhir-client.ts` | New: `searchSurgicalAppointments()`, `getPatient()`, `getPractitioner()`, `searchPractitioners()`, `searchLocations()`, `resolveAppointmentDetails()` |
| `lib/epic/case-mapper.ts` | New: dynamic mapper with smart coercion — `mapAppointmentToPreview()`, `createCaseFromImport()` using `create_case_with_milestones` RPC with `p_patient_id` + `p_source='epic'` |
| `app/api/epic/cases/search/route.ts` | New: GET — search appointments by date range (forward only, max 30 days) + optional surgeon filter |
| `app/api/epic/cases/import/route.ts` | New: POST — sequential import with per-case result, creates patient records, logs to import_log |
| `app/settings/integrations/epic/import/page.tsx` | New: server component |
| `app/settings/integrations/epic/import/PageClient.tsx` | New: date range picker (default today+7), surgeon filter (mapped only), skeleton loading, preview table (date/patient/surgeon/room/procedure/status/checkbox), import progress bar, results summary with case links |
| `lib/dal/epic.ts` | Add: `createImportLogEntry()`, `listImportLog()`, `checkDuplicateImport()` |

### Commit message
`feat(epic): phase 4 - fhir client, dynamic case mapper, case import page`

### 3-stage test gate
1. **Unit:** FHIR client response parsing, case mapper coercion (ISO date → date, reference → UUID, string normalization), field mapping loading, duplicate detection, EPIC-{id} case number generation
2. **Integration:** Search Epic appointments → preview with mapping status → cases with missing mappings have disabled checkboxes → import selected → cases created with correct patient data + milestones + source='epic' → import log entries created with `imported_by` → audit log shows `epic.cases_imported` → duplicate import returns "already imported"
3. **Workflow:** Full import flow: open import page → set date range → see appointments from Epic sandbox → select ready cases → import → watch progress → view created cases in case list (Epic badge visible) → open case detail (patient info from FHIR) → check audit log (import events with user attribution)

---

## Phase 5: Auto-Matcher + Polish

**Complexity:** Medium

### What it does
- Implements Levenshtein-based fuzzy matching (no external deps, normalized 0-1 score)
- Auto-apply ≥0.90 confidence, suggest 0.70-0.89 for manual review
- Adds Auto-Match button to entity mapping UI with Accept/Reject UX for suggestions
- Adds proactive token expiry countdown on Epic overview page
- Adds skeleton loading states for FHIR queries (2-5s expected)
- Implements retry logic for transient FHIR errors (exponential backoff, 3 retries, 10s timeout)
- Error handling: invalid FHIR data → skip + log, partial import failure → continue with others

### Files touched
| File | Change |
|------|--------|
| `lib/epic/auto-matcher.ts` | New: Levenshtein distance, `autoMatchSurgeons()`, `autoMatchRooms()`, `autoMatchProcedures()` |
| `app/api/epic/mappings/auto-match/route.ts` | New: POST — run auto-matching, return results with confidence scores |
| `app/settings/integrations/epic/mappings/PageClient.tsx` | Update: "Auto-Match" button, suggested matches with confidence %, Accept/Reject buttons |
| `app/settings/integrations/epic/PageClient.tsx` | Update: token expiry countdown, amber warning <10min, red "Reconnect" when expired |
| `lib/epic/fhir-client.ts` | Update: add 10s timeout, exponential backoff for 429, skip invalid data |
| `lib/epic/token-manager.ts` | Update: proactive expiry check, `getTokenExpiryInfo()` for countdown |
| Epic page components | Add skeleton loading states during FHIR fetches |

### Commit message
`feat(epic): phase 5 - auto-matcher, token expiry UX, error handling, loading states`

### 3-stage test gate
1. **Unit:** Levenshtein distance (exact=1.0, close>0.8, none<0.5), threshold logic (auto/suggest/skip), retry backoff timing, timeout behavior
2. **Integration:** Auto-match → correct high-confidence applied → suggestions shown → accept/reject works → mapping stats update; token countdown displays correctly; expired token shows reconnect; audit log shows `epic.auto_match_run`
3. **Workflow:** Connect Epic → run auto-match for surgeons/rooms → review suggestions → accept some → import cases → view with Epic badge → check audit trail → let token expire → see reconnect prompt → reconnect

---

## Phase 6: Security Hardening + Final Testing

**Complexity:** Small-Medium

### What it does
- Full security checklist verification per spec
- Verifies client_secret never in frontend bundle
- Verifies RLS isolation across all Epic tables
- Verifies OAuth state validation (reject mismatch, reject expired)
- Verifies Vault encryption on token storage
- Verifies analytics views exclude patient data
- Documents environment variables
- Runs full test suite: `npm run typecheck && npm run lint && npm run test`

### Files touched
| File | Change |
|------|--------|
| `middleware.ts` | Verify Epic API routes protected |
| All `app/api/epic/` routes | Verify: facility_id scoping, admin permissions, error responses |
| `lib/epic/token-manager.ts` | Verify: Vault encryption, expired handling, rate limit retry |
| `lib/epic/fhir-client.ts` | Verify: timeouts, invalid data handling, partial failure |
| `.env.example` | Document all Epic env vars with descriptions |
| All Epic components | Verify: no patient data in analytics, no secrets in client code |

### Commit message
`feat(epic): phase 6 - security hardening, verification, documentation`

### 3-stage test gate
1. **Unit:** OAuth state validation (reject mismatch, reject expired cookie), rate limit backoff, invalid FHIR data skip + log
2. **Integration:** RLS test: user A cannot read user B's facility Epic data; non-admin cannot write field mappings; token read returns decrypted value from Vault; client_secret absent from any client-side bundle
3. **Workflow:** Full security checklist walkthrough — all items checked off; `npm run typecheck && npm run lint && npm run test` passes clean

---

## Dependencies

```
Phase 1 (Patient Fields) ──────────────────────────────────────┐
                                                                 │
Phase 2a (Schema + Auth) ──→ Phase 2b (Field Mapping UI)       │
         │                                                       │
         └──→ Phase 3 (Settings + Entity Mapping)               │
                       │                                         │
                       └──→ Phase 4 (FHIR Client + Import) ◄───┘
                                      │
                                      └──→ Phase 5 (Auto-Matcher + Polish)
                                                    │
                                                    └──→ Phase 6 (Security + Final)
```

**Phase 1 is independent** — can be shipped standalone.
**Phases 2a → 2b → 3 → 4 → 5 → 6** are sequential.
**Phase 4 depends on Phase 1** (uses `p_patient_id` + `p_source` in RPC).

---

## Environment Variables (New)

```bash
# Epic FHIR Integration
EPIC_CLIENT_ID=930fa123-246d-4aeb-9972-ddf3496ab292
EPIC_CLIENT_SECRET=<sandbox secret>
EPIC_FHIR_BASE_URL=https://fhir.epic.com/interconnect-fhir-oauth
EPIC_REDIRECT_URI=<env-specific: localhost/ngrok/production URL>
```

---

## Risk Assessment

| Risk | Mitigation |
|------|-----------|
| Epic sandbox rate limiting | Cache FHIR responses locally during dev. Mock responses for automated tests. |
| OAuth redirect URI changes | `EPIC_REDIRECT_URI` env var — configurable per environment |
| Token expiry during import | Check validity before each FHIR request. Proactive countdown UX. |
| FHIR data shape varies | Only model fields ORbit uses. Skip + log invalid records. |
| Patient data in analytics | Hard rule: analytics queries NEVER join patient data |
| Auto-match false positives | 0.90 threshold for auto-apply. Suggestions require manual confirmation. |
| Vault extension availability | Check + enable pgsodium in migration. Fall back to table storage if Vault unavailable. |
| MRN conflicts across facilities | MRN lookup scoped to facility_id. Same MRN in different facilities = different patients. |

---

## Session Log
<!-- Append phase completion entries here -->
