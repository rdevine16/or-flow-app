# Current Work: Production Readiness Fixes

## Goal
Fix critical and high-priority production readiness issues found during pre-launch audit. These are NEW findings that supplement the existing 15-phase remediation plan in `docs/implementation-plan.md`.

## Status
- **Branch:** `fix/production-readiness`
- **Current Phase:** In progress
- **Scope:** Build fixes, security headers, Sentry config, 404 page, offline handling, env cleanup

## Findings (new — not in existing remediation plan)

### CRITICAL
1. **Build broken** — `useMilestoneRealtime.ts:173` calls `logger.info()` but `logger` is a factory function. Needs `const log = logger('useMilestoneRealtime')`.
2. **Env var mismatch** — `lib/env.ts` expects `NEXT_PUBLIC_APP_URL` but `.env.*` files define `NEXT_PUBLIC_SITE_URL`. Runtime crash in production.

### HIGH
3. **No security headers** — `next.config.ts` missing `X-Frame-Options`, `X-Content-Type-Options`, `Content-Security-Policy`, `Referrer-Policy`.
4. **No custom 404 page** — No `app/not-found.tsx`. Users see default Next.js 404.
5. **Sentry 100% trace sampling** — `tracesSampleRate: 1` in all 3 Sentry configs. Expensive in production.
6. **Sentry `sendDefaultPii: true`** — Sends PII to Sentry. HIPAA concern for healthcare app.
7. **Demo-data endpoints lack role authorization** — Any authenticated user can hit `/api/demo-data/*`.

### MEDIUM
8. **No offline/network error handling** — No `navigator.onLine` detection, no retry logic.
9. **Missing `.env.example`** — No template for required env vars.
10. **Missing `robots.txt`** — Login-required app should block search engine indexing.
11. **Minimal metadata** — Only root layout has basic title/description. No OG tags, no page titles.

### Items already covered by existing remediation plan
- Rate limiter (Phase 2)
- Race conditions / optimistic locking (Phase 3 + 11)
- Validation layer (Phase 9)
- Error boundaries at page level (Phase 15)
- Demo data auth at role level (Phase 6)
- Accessibility improvements (not in plan — add to Phase 15 backlog)

---

## Previous Feature: Audit Remediation
The 15-phase remediation plan at `docs/implementation-plan.md` remains active. This production-readiness work is a prerequisite fix that should land first.

---

## Review Q&A

> Generated by /review on 2026-02-25

**Q1:** Commit 036c063 already tackled several items (logger fix, security headers, 404 page, robots.txt, offline banner, demo-data auth guards). However, `instrumentation-client.ts:11` still has `tracesSampleRate: 1` and `instrumentation-client.ts:17` still has `sendDefaultPii: true` — the server and edge configs were fixed but the CLIENT config was missed. What's your intent for this session?
**A1:** Only remaining items — skip what's already committed, focus on items NOT yet addressed.

**Q2:** For the client-side Sentry sampling rate, the server/edge are at 0.1 (10%). Should the client match at 0.1, or a different rate?
**A2:** Match server at 0.1 (10%). Consistent across all environments.

**Q3:** The CSP uses `'unsafe-eval'` and `'unsafe-inline'`. Should we tighten it with nonces (non-trivial change)?
**A3:** Keep current CSP. It's a significant improvement over having none. Nonce-based CSP can be a follow-up in the remediation plan.

**Q4:** Finding #11 notes minimal metadata — no pages export titles. How much metadata work?
**A4:** Page titles for all 84 pages. No OG tags (login-required app).

**Q5:** For 'use client' pages, Next.js metadata exports only work in Server Components. Which approach?
**A5:** Thin server wrapper per page — rename page.tsx to PageClient.tsx, create new page.tsx that exports metadata and renders the client component.

**Q6:** For dynamic routes like /cases/[id], generic or dynamic titles?
**A6:** Generic titles ("Case Detail", "Edit Case"). No DB queries.

**Q7:** OfflineBanner handles offline detection but no retry-on-reconnect logic. Should we add retry?
**A7:** Banner is sufficient. Retry logic is complex and belongs in the remediation plan.

**Q8:** `global-error.tsx` renders the default NextError component. Should it get custom branded treatment?
**A8:** Yes — custom branded page matching 404 and ErrorBoundary aesthetic.

**Q9:** ErrorBoundary in layout.tsx WRAPS ToastProvider, but ErrorBoundary.tsx USES useToast(). This is a bug — ErrorBoundary can't access Toast context since it's above ToastProvider in the tree.
**A9:** Fix: move ErrorBoundary inside ToastProvider.

**Q10:** Sentry example page and test API route exist (`app/sentry-example-page/`, `app/api/sentry-example-api/`). These are scaffolded by @sentry/wizard.
**A10:** Remove both. They serve no purpose in production.

**Q11:** Security headers missing `Strict-Transport-Security` (HSTS). Vercel adds it automatically but should we add explicitly?
**A11:** Add HSTS for defense in depth.

**Q12:** The 404 page has no metadata export. Should we add a title?
**A12:** Yes — add `export const metadata = { title: 'Page Not Found' }`.

**Q13:** ~63 raw console.log calls across the codebase. Should we clean up?
**A13:** Fix all. Convert everything to structured logger.

**Q14:** Logging infrastructure files (logger.ts, error-tracking.ts, error-logger.ts, audit-logger.ts) — exceptions for console.log?
**A14:** Review each file individually. logger.ts is exempt (it IS the logger). Others case-by-case.

**Q15:** The refactor tool (app/refactor/ + app/api/refactor/) is a developer utility with 11 console.log calls.
**A15:** Delete the entire refactor tool. Not needed in production.

**Q16:** `app/admin/docs/page.tsx` — internal dev tool or user-facing admin feature?
**A16:** Remove the docs page too.

**Q17:** Delete admin/docs + check connected files (supabaseIntrospection.ts, pageRegistry.ts)?
**A17:** Clean sweep — delete admin/docs/page.tsx, lib/supabaseIntrospection.ts, lib/pageRegistry.ts, remove nav link and breadcrumb entries.

**Q18:** Two overlapping error infrastructure files: error-tracking.ts (Sentry stub with commented imports) and error-logger.ts (DB-backed logging with broken window.Sentry). Both redundant now that Sentry is properly configured.
**A18:** Remove both. Sentry is properly configured. These are dead scaffolding.

**Q19:** Login page uses errorLogger in 7 places. How to replace when removing error-logger.ts?
**A19:** Replace with structured logger: `const log = logger('login')` then `log.warn(...)` / `log.error(...)`.

**Q20:** demo-data-generator.ts has 24 console.log calls. Convert or leave?
**A20:** Convert to structured logger.

**Q21:** audit-logger.ts has 2 console calls (fallback paths). Convert?
**A21:** Convert to structured logger.

**Q22:** Should we include a build verification step after all fixes?
**A22:** Yes — run `npm run build` as final check.

**Q23:** Naming convention for client page files when splitting for metadata wrappers?
**A23:** PascalCase: `PageClient.tsx`.

**Q24:** Check each page for 'use client' and only create wrappers where needed?
**A24:** Yes — server component pages get metadata directly, only 'use client' pages get wrappers.

**Q25:** Login page and public status page title format?
**A25:** Simple titles: Login page = "Sign In", Status page = "Case Status".

**Q26:** Commit strategy for all these changes?
**A26:** Separate commits: security fixes, dead code removal, console.log cleanup, metadata.

**Q27:** lib/supabase.ts and lib/supabase-server.ts use `process.env.X!` instead of validated env.ts. Update?
**A27:** Yes — replace with env.NEXT_PUBLIC_SUPABASE_URL and env.NEXT_PUBLIC_SUPABASE_ANON_KEY.

**Q28:** Login page footer has /privacy and /terms links that lead to 404.
**A28:** Remove the links until those pages exist.

**Q29:** Sentry tunnel route at /monitoring — should we add it to PUBLIC_ROUTES in middleware?
**A29:** Yes — add '/monitoring' to PUBLIC_ROUTES. Trust Sentry's recommended pattern, no extra validation needed.

**Q30:** Full scope: 14 work items including security fixes, dead code removal, console.log cleanup, metadata for all 84 pages, and build verification. All in one session?
**A30:** Yes — do everything.
