# Implementation Plan: Cases Page Revamp

> Generated by /audit on 2026-02-13
> Feature spec: `docs/active-feature.md`
> Review Q&A: 28 decisions documented in `docs/active-feature.md`

## Summary

Transform the Cases page from a basic list into an enterprise-grade data table with:
- Shopify-style status tabs with count badges (URL-driven)
- Contextual summary metric cards per tab
- @tanstack/react-table with sortable columns, checkboxes, procedure icons, flags indicators
- Server-side pagination and sorting
- Case detail drawer (Radix Sheet) with fixed header + 3 tabs (Financials, Milestones, Flags)
- Validate, bulk validate, cancel (with reasons), and CSV export actions
- Full rewrite of the existing 600-line page using proper DAL patterns

## Key Decisions from Review

| Decision | Choice |
|----------|--------|
| Page strategy | Full rewrite |
| Table engine | @tanstack/react-table (new dep) |
| Drawer engine | @radix-ui/react-dialog / shadcn Sheet (new dep) |
| Date range | Reuse existing DateRangeSelector |
| Tab routing | URL query params (?tab=) |
| Pagination | Server-side (.range() + {count: 'exact'}) |
| Sorting | Server-side via extended DAL |
| Proc icons | Code-level Lucide mapping by category |
| Metric cards | Server-side aggregation, full tab-specific |
| Drawer layout | Fixed header + 3 tabs (Financials, Milestones, Flags) |
| Financials arch | Pure functions in lib/financials.ts + thin hook |
| Bulk validate | Sequential with progress indicator |
| Cancel action | Modal with cancellation reasons (replaces delete) |
| Export | Server-side full fetch, CSV client-side |
| ProgressPill | Deferred |
| Activity tab | Dropped |
| Custom saved tabs | Dropped |
| Mobile | Desktop only |

## Audit Findings

1. **CASE_LIST_SELECT missing procedure_types** — The DAL's select string doesn't join procedure_types. Will fix globally (approved by user).
2. **No @tanstack/react-table or @radix-ui/react-dialog installed** — Both need to be added in Phase 1.
3. **Existing Modal.tsx is a centered dialog** — Not suitable for a side drawer. Radix Sheet is the right approach.
4. **useProcedureCategories() hook exists** in hooks/useLookups.ts — Can use for icon mapping.
5. **useCancellationReasons() hook exists** — Can use for cancel modal.
6. **Cancel page at app/cases/[id]/cancel/** — Has full flow to extract into a reusable modal.
7. **surgeon_procedure_stats** (not "averages") and **facilities.or_hourly_rate** (not facility_analytics_settings) — Schema corrections noted.
8. **Financial analytics page** shows pattern for querying materialized views with client-side joins.

---

## Phase 1: Foundation — Dependencies, Constants, DAL Extensions

**What it does:** Installs dependencies, creates constants/config files, extends the DAL and design tokens. No UI changes — pure infrastructure.

**Files touched:**
- `package.json` — install @tanstack/react-table, @radix-ui/react-dialog
- `lib/dal/cases.ts` — fix CASE_LIST_SELECT, add sort params, add new query functions (listForCasesPage, countByTab, flagsByCase)
- `lib/dal/index.ts` — export new types (SortParams)
- `lib/constants/procedureIcons.ts` — NEW: category name → Lucide icon mapping
- `lib/constants/caseStatusConfig.ts` — NEW: status → color/label config including needs_validation, on_hold
- `lib/design-tokens.ts` — add needs_validation and on_hold to statusColors

**Commit message:** `feat(cases): phase 1 - foundation dependencies, constants, and DAL extensions`

**3-stage test gate:**
1. **Unit:** DAL functions return expected shapes with mock data. Constants export correct mappings.
2. **Integration:** DAL queries execute against Supabase without errors. Extended CASE_LIST_SELECT returns procedure_types.
3. **Workflow:** Existing pages that use casesDAL (dashboard) still render correctly after CASE_LIST_SELECT change.

**Complexity:** Medium

---

## Phase 2: Page Shell, Status Tabs, and Date Range

**What it does:** Rewrites app/cases/page.tsx with the new layout structure. Creates the status tabs component with count badges. Integrates the existing DateRangeSelector above tabs. Establishes URL query param sync for tab + date range. Carries over CreateCaseSplitButton and FloatingActionButton.

**Files touched:**
- `app/cases/page.tsx` — full rewrite (page shell, layout, state management)
- `components/cases/CasesStatusTabs.tsx` — NEW: tab bar with count badges
- `lib/hooks/useCasesPage.ts` — NEW: main page hook (tab counts, date range state, tab state)

**Commit message:** `feat(cases): phase 2 - page shell with status tabs and date range selector`

**3-stage test gate:**
1. **Unit:** CasesStatusTabs renders all tabs with counts. Tab click updates URL params.
2. **Integration:** useCasesPage fetches tab counts from Supabase. DateRangeSelector onChange updates data scope.
3. **Workflow:** Navigate to /cases → see tabs with counts → click tab → URL updates → counts reflect selected date range.

**Complexity:** Large

---

## Phase 3: Data Table with @tanstack/react-table

**What it does:** Creates the core data table component using tanstack-table. Implements column definitions with procedure icons, status badges, duration, flags indicator dots, and hover actions. Server-side sorting and pagination. Custom empty states per tab.

**Files touched:**
- `components/cases/CasesTable.tsx` — NEW: tanstack-table data table
- `components/ui/ProcedureIcon.tsx` — NEW: category → Lucide icon component
- `app/cases/page.tsx` — integrate CasesTable into page shell
- `lib/hooks/useCasesPage.ts` — add table data fetching, sort state, pagination state

**Commit message:** `feat(cases): phase 3 - data table with tanstack-table, procedure icons, and server-side pagination`

**3-stage test gate:**
1. **Unit:** CasesTable renders columns correctly. ProcedureIcon maps categories to icons with fallback. Empty states show per tab.
2. **Integration:** Table fetches data with sort/pagination params via DAL. Column sorting triggers server-side re-fetch. Pagination controls work.
3. **Workflow:** Load /cases → see table with real data → sort by surgeon → paginate → switch tab → table updates with correct filtered data.

**Complexity:** Large

---

## Phase 4: Search and Filter Bar

**What it does:** Refactors the existing CasesFilterBar to work with the new page structure. Removes date range and status dropdowns (now handled by DateRangeSelector and tabs). Keeps search + surgeon/room/procedure filter dropdowns. Adapts URL sync to coexist with tab + date params.

**Files touched:**
- `components/cases/CasesFilterBar.tsx` — NEW (refactored from components/filters/CaseFilterBar.tsx)
- `app/cases/page.tsx` — integrate new filter bar
- `lib/hooks/useCasesPage.ts` — add filter state management, wire filters to DAL queries

**Commit message:** `feat(cases): phase 4 - refactored search and filter bar with URL sync`

**3-stage test gate:**
1. **Unit:** Filter bar renders search input + surgeon/room/procedure dropdowns. Active filter pills appear and are dismissible. Clear all works.
2. **Integration:** Search debounces at 300ms and re-fetches from server. Filter selections update URL params and trigger data refresh.
3. **Workflow:** Search for a surgeon name → results filter → add room filter → both pills shown → clear all → full list returns.

**Complexity:** Medium

---

## Phase 5: Summary Metric Cards

**What it does:** Creates contextual summary metric cards that change based on the active tab. Implements server-side aggregation queries for each tab's metrics. Uses the existing MetricCard component.

**Files touched:**
- `components/cases/CasesSummaryCards.tsx` — NEW: tab-aware metric cards
- `lib/hooks/useCaseMetrics.ts` — NEW: server-side aggregation queries per tab

**Metric configurations:**
- All/Today: Cases Completed vs Scheduled, Median Duration, On-Time Start %
- Completed: Total Cases, Median Duration, Total Profit
- Needs Validation: Count, Oldest Unvalidated (days), Data Completeness %
- Scheduled: Cases Scheduled, Total Scheduled OR Time, Surgeons Operating
- In Progress: Active Cases, Avg Progress %, Rooms In Use

**Commit message:** `feat(cases): phase 5 - contextual summary metric cards with server-side aggregation`

**3-stage test gate:**
1. **Unit:** CasesSummaryCards renders 3 cards for each tab type. Loading skeleton shows while fetching.
2. **Integration:** useCaseMetrics fetches correct aggregation per active tab. Metrics update when date range or tab changes.
3. **Workflow:** Switch between tabs → metric cards animate to new values → change date range → cards update.

**Complexity:** Medium

---

## Phase 6: Case Drawer — Shell, Header, and Flags Tab

**What it does:** Creates the case drawer using Radix Sheet (shadcn pattern). Implements the fixed header section with case metadata, quick stats, and validate button. Adds the Flags tab as the first tab (simplest, data already in casesDAL.getById). Wires row click → open drawer.

**Files touched:**
- `components/cases/CaseDrawer.tsx` — NEW: drawer shell with Radix Sheet
- `components/cases/CaseDrawerFlags.tsx` — NEW: flags tab content
- `lib/hooks/useCaseDrawer.ts` — NEW: drawer data fetching hook
- `app/cases/page.tsx` — wire row click → drawer open, drawer state management

**Commit message:** `feat(cases): phase 6 - case drawer with header, quick stats, and flags tab`

**3-stage test gate:**
1. **Unit:** CaseDrawer renders with correct header info. Flags tab shows flag list or "No flags" empty state. Close button and Escape key work.
2. **Integration:** Row click fetches case detail via DAL. Drawer opens with ~550px width, overlay dims background. Case links navigate correctly.
3. **Workflow:** Click a table row → drawer slides open with case info → see flags (or empty state) → click "Open full detail" → navigates to /cases/[id] → close drawer → return to table.

**Complexity:** Medium

---

## Phase 7: Drawer — Milestones Tab

**What it does:** Creates the Milestones tab showing every milestone with timestamps, intervals between consecutive milestones, and comparison badges against surgeon and facility medians. Uses simple percentage thresholds for color coding.

**Files touched:**
- `components/cases/CaseDrawerMilestones.tsx` — NEW: milestones tab content
- `lib/hooks/useCaseDrawer.ts` — add milestone comparison data fetching (surgeon_procedure_stats, facility_procedure_stats)

**Commit message:** `feat(cases): phase 7 - drawer milestones tab with median comparisons`

**3-stage test gate:**
1. **Unit:** Milestones render in order with timestamps and intervals. Color coding: green (faster), amber (within 10%), red (>10% over). Summary row computes correctly.
2. **Integration:** Lazy-loads milestone comparison data when tab is activated. Handles cases with no surgeon stats (graceful fallback).
3. **Workflow:** Open drawer → click Milestones tab → see milestone timeline with intervals and comparison badges → verify color coding matches actual vs median.

**Complexity:** Medium

---

## Phase 8: Drawer — Financials Tab

**What it does:** Creates the Financials tab with projected vs actual financial data. Implements pure calculation functions in lib/financials.ts. Thin hook wrapper fetches raw data from case_completion_stats, surgeon_procedure_stats, facilities.or_hourly_rate, and procedure_cost_items.

**Files touched:**
- `components/cases/CaseDrawerFinancials.tsx` — NEW: financials tab content
- `lib/financials.ts` — NEW: pure financial calculation functions
- `lib/hooks/useCaseFinancials.ts` — NEW: thin data-fetching hook

**Behavior by status:**
- Scheduled: Projected only (revenue, OR cost, supply costs, credits, margin)
- In Progress: Projected with "Final financials available after completion" note
- Completed: Two-column projected vs actual with color-coded deltas

**Commit message:** `feat(cases): phase 8 - drawer financials tab with projected vs actual calculations`

**3-stage test gate:**
1. **Unit:** Pure functions compute projections correctly. Graceful degradation for zero costs ("Cost data unavailable") and missing surgeon stats ("No benchmark available").
2. **Integration:** Hook fetches from 4 tables in parallel. Completed cases show two-column layout with deltas. Scheduled cases show projections only.
3. **Workflow:** Open drawer for scheduled case → see projections → open completed case → see projected vs actual with green/red deltas → open case with missing cost data → see "Cost data unavailable" message.

**Complexity:** Large

---

## Phase 9: Actions — Validate, Bulk Validate, Cancel, and Export

**What it does:** Implements all actions: single validate (table hover + drawer button), bulk validate with sequential progress, cancel modal with cancellation reasons, and CSV export.

**Files touched:**
- `components/cases/CasesTable.tsx` — add validate hover action, bulk action bar
- `components/cases/CaseDrawer.tsx` — wire validate button in header
- `components/cases/CancelCaseModal.tsx` — NEW: extracted from app/cases/[id]/cancel/
- `components/cases/BulkValidateProgress.tsx` — NEW: sequential validation with progress
- `lib/hooks/useCasesPage.ts` — add validate/cancel/export handlers
- `app/cases/page.tsx` — wire modals and export button

**Commit message:** `feat(cases): phase 9 - validate, bulk validate, cancel modal, and CSV export`

**3-stage test gate:**
1. **Unit:** CancelCaseModal renders reason dropdown with categories. BulkValidateProgress shows "Validating 3 of 12" UI. CSV formatter includes all visible columns.
2. **Integration:** Single validate sets data_validated=true and triggers record_case_stats. Bulk validate processes sequentially, skips failures. Cancel sets status to cancelled with reason. Export fetches full filtered dataset (not just current page).
3. **Workflow:** Select 3 rows → click "Validate Selected" → see progress → table updates. Click cancel on a row → select reason → confirm → status changes. Click Export → CSV downloads with current filters.

**Complexity:** Large

---

## Phase Summary

| Phase | Description | Complexity | Key Files |
|-------|-------------|------------|-----------|
| 1 | Foundation — deps, constants, DAL | Medium | dal/cases.ts, constants/, design-tokens.ts |
| 2 | Page shell + status tabs + date range | Large | app/cases/page.tsx, CasesStatusTabs.tsx |
| 3 | Data table with tanstack-table | Large | CasesTable.tsx, ProcedureIcon.tsx |
| 4 | Search and filter bar | Medium | CasesFilterBar.tsx |
| 5 | Summary metric cards | Medium | CasesSummaryCards.tsx, useCaseMetrics.ts |
| 6 | Drawer shell + header + flags tab | Medium | CaseDrawer.tsx, CaseDrawerFlags.tsx |
| 7 | Drawer milestones tab | Medium | CaseDrawerMilestones.tsx |
| 8 | Drawer financials tab | Large | CaseDrawerFinancials.tsx, lib/financials.ts |
| 9 | Actions — validate, cancel, export | Large | CancelCaseModal.tsx, BulkValidateProgress.tsx |

**Total: 9 phases** (3 large, 4 medium, 0 small + Phase 1 medium)

## Dependencies Between Phases

```
Phase 1 (Foundation)
  └─> Phase 2 (Page Shell + Tabs)
        ├─> Phase 3 (Data Table)
        │     ├─> Phase 4 (Filter Bar)
        │     ├─> Phase 6 (Drawer + Flags)
        │     │     ├─> Phase 7 (Milestones Tab)
        │     │     └─> Phase 8 (Financials Tab)
        │     └─> Phase 9 (Actions)
        └─> Phase 5 (Summary Cards)
```

## Deferred Items (not in this plan)

- ProgressPill component (milestone progress in table rows)
- Activity tab in drawer
- Custom saved tabs ("+" button)
- Mobile/responsive optimization
- Real-time WebSocket updates for in-progress cases
